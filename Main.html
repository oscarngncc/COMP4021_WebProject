<!DOCTYPE html>
<html>
    <head>
        <title>Special Tetris Game</title>
        <meta charset="utf-8"/>
        <link href="MainStyle.css" rel="stylesheet" type="text/css">
        <link href="Responsive.css" rel="stylesheet" type="text/css">
        <meta name="viewport" content="width=device-width, initial-scale=1" >
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="TetrisBlock.js"></script>
    </head>

    <body onload="Main()">
        <!--Script Goes here-->
        <script>
            /* true if the block player previously controlled reaches to the bottom/another block*/
            var isSettled = true;

            /* Current Position of the User-Controlled TetrisBlock, based on Canvas*/
            var xPos = 0; 
            var yPos = 0;

            /* 10 x 8 2-Dimensional Matrix Canvas 
               with DOM "TetrisBlock" element inside if yes,
               null otherwise 
            */
            var Canvas = new Array(10);
            for ( var i = 0; i < 10; i++)
            {
                var Canvas_Col = new Array(8);
                Canvas[i] = Canvas_Col;
            }

            //Timer
            var Timer;


            /* User Accessible Variables here*/
            var UserControlBlocks = [];
            var CurrentOptions;



            
            /* Helper Function for Changing position of elements inside Canvas, Parameters:
               Dimension - 0 which is x position, 1 which is y position
               Distance: How much (based on canvas) should the block move
            */
            function CanvasMoveBlock( Dimension, Distance )
            {
                if ( UserControlBlocks.length == 0 ){ return false;}

                //Blocks cannot be moved if it's already settled
                if ( isSettled  ){ return false; }

                var TxPos = xPos + getRowLength(CurrentOptions) -1;
                var TyPos = yPos + getColumnLength(CurrentOptions) -1;
                
            
                //It may already be settled, but not updated yet
                if ( TxPos >= 9 )
                {  
                    isSettled = true; 
                    return false;
                }
                for ( var j = 0; j < getColumnLength(CurrentOptions); j++ )
                {
                    if ( Canvas[TxPos+1][ yPos+j] != null && Canvas[TxPos][ yPos+ j] != null )
                    {  
                        isSettled = true; 
                        return false; 
                    }
                }



                //Out of Boundary Checking
                var Pos = ( Dimension  == 0 )? xPos : yPos;
                var TPos = ( Dimension == 0 )? TxPos: TyPos;
                var UpperBoundery = (Dimension == 0 )? 9 : 7;
                if ( TPos + Distance > UpperBoundery || Pos + Distance < 0 ){
                    return false; 
                }
                
                
                var MovedxPos = ( Dimension == 0 )? xPos + Distance: xPos;
                var MovedyPos = ( Dimension != 0 )? yPos + Distance: yPos;

                

                //Check If movable to the position
                var canMove = true;
                for ( var i = 0; i < getRowLength(CurrentOptions); i++ )
                {
                    for ( var j = 0; j < getColumnLength(CurrentOptions); j++ )
                    {
                        if ( Canvas[xPos + i][yPos + j] != null )
                        {
                            var MovedPosition =Canvas[MovedxPos + i][MovedyPos + j];
                            if ( MovedPosition != null )
                            {
                                if ( ! UserControlBlocks.includes(MovedPosition) )
                                {
                                    canMove = false; break;
                                }
                            }
                        }
                    }
                }

                if ( canMove )
                {
                    for ( var i = 0; i < getRowLength(CurrentOptions); i++ )
                    {
                        for ( var j = 0; j < getColumnLength(CurrentOptions); j++ )
                        {
                            if ( Canvas[xPos + i][yPos + j] != null )
                            {
                                //Splice All blocks first
                                var block = Canvas[xPos + i][yPos + j];
                                Canvas[xPos+i].splice( yPos + j, 1, null );
                            }
                        }
                    }
                    var count = 0;
                    for ( var i = 0; i <4; i++)
                    {
                        for ( var j = 0; j<4; j++)
                        {
                            if ( CurrentOptions[i][j] != 0  )
                            {
                                //Insert All blocks
                                var block = UserControlBlocks[count];
                                Canvas[MovedxPos+i].splice(MovedyPos+j, 1, block );

                                //Update Actual Block Position in URL
                                block.style.top = (5 + (MovedxPos+i)*5).toString() + "rem"; 
                                block.style.left = (0 + (MovedyPos+j)*5 + 20 ).toString() + "rem";

                                isSettled = false;
                                count++;
                            }
                        }
                    }
                    xPos = MovedxPos;
                    yPos = MovedyPos;

                    return true;
                }
                else { console.log("Fuck"); }

                return false;   
            }



            function CreateBlock()
            {
                if ( isSettled )
                {
                    /* New Block Position, randomly of either 0-7th column and first row */
                    xPos = 0;
                    yPos = Math.floor( Math.random() * (8-4) );

                    //Make Previous UserControlBlocks no longer controllable                    
                    if ( $(".UserControlBlock")[0] )
                    {
                        //Previous block doesn't have ".UserControlBlock" class anymore
                        $(".UserControlBlock").each( function(){
                            $(this).attr("class", "TetrisBlock");
                        });
                        UserControlBlocks = [];
                    }

                    //Create new Block
                    var GameArea = document.getElementById("GameArea");

                    //CurrentOptions = Option7;
                    CurrentOptions = getRandomOption(); //Return a Two-Dimensional Integer Array
 
                    for ( var i = 0; i < 4; i++ )
                    {
                        for ( var j = 0; j <4; j++ )
                        {
                            if ( CurrentOptions[i][j] != 0 )
                            {
                                var block = document.createElement("div");
                                block.setAttribute("class", "TetrisBlock UserControlBlock");
                                block.style.top = (5 + (xPos+i)*5).toString() + "rem"; 
                                block.style.left = (0 + (yPos+j)*5 + 20 ).toString() + "rem";

                                GameArea.appendChild(block);   //Add to Web Interface
                                UserControlBlocks.push(block); //Label Block as User Controllable
                                Canvas[0+i][yPos+j] = block;  //Add Block to Canvas 
                                
                            }
                        }
                    }
                    console.log("creation");
                    isSettled = false; 
                }              
            }




            function CheckRowCondition()
            {
                for ( var i = 9; i >= 0; i-- )
                {
                    var AllFilled = true;
                    for ( var j = 0; j < 8; j++ )
                    {
                        if ( Canvas[i][j] == null ){ AllFilled = false; break; }
                    }

                    //When a Row is filled, remove that row and update other TetrisBlock
                    if ( AllFilled && isSettled == true ) 
                    {
                        clearTimeout(Timer);
                        UserControlBlocks = [];

                        //Revmove The Fully Filled Row
                        for ( var k = 0; k < 8; k++ )
                        {
                            var block = Canvas[i][k];
                            var GameArea = document.getElementById("GameArea");
                            GameArea.removeChild(block);
                            Canvas[i][k] = null;    
                        }

                        
                        //Update All other tetrisBlocks by moving down 1 layer
                        for ( var a = i-1; a>= 0; a-- )
                        {
                            for ( var b = 0; b < 8; b++ )
                            {
                                //Update Array
                                var block = Canvas[a][b];
                                if ( block != null )
                                {
                                    Canvas[a].splice( b, 1, null );
                                    Canvas[a+1].splice( b, 1, block );
                                    block.style.top = (5 + (a+1)*5).toString() + "rem";   
                                }                              
                            }
                        }
                        i++;
                    }
                }
            }




            /*Function Called for each timer iteration, Bascially Sum up everything*/
            function IterationFunc()
            {
                
                CanvasMoveBlock( 0, 1 ); //User-Controlled Block will drop each time interval
                CheckRowCondition();
                
                //Check GameOver                
                for ( var i = 0; i < 8; i++ )
                {
                    if ( Canvas[0][i] != null ){ 
                        isSettled = true;
                        clearTimeout(Timer);
                        alert("GAMEOVER"); 
                        return;
                    }
                }

                CreateBlock();
                Timer = setTimeout(IterationFunc, 500);
            }




            function Main()
            {
                Timer = setTimeout(IterationFunc, 500);

                //When User Press the button
                $(document).on("keydown", function(e){
                    if ( e.keyCode == 37 )  //Press Left
                    {
                        CanvasMoveBlock(1, -1);
                    }
                    else if ( e.keyCode == 39 ) //Press Right
                    {
                        CanvasMoveBlock(1, 1);
                    }
                    else if ( e.keyCode == 38 ) //Press Up, Change Direction
                    {

                    }
                    else if ( e.keyCode == 40 ) //Press Down, //Increase DownSpeed
                    {
                        CanvasMoveBlock(0, 1);
                    }
                });
            }

        </script>
        <!--Script Ends here-->

        <div id="Game">
            <div id = "Board1" class = "GameDataBoard">
                <p>Next Block Dropping:</p>
                <p>Score: 20000</p>
            </div>
            <div id = "GameArea">
                <div id="BorderLine"></div>
                <div id="BaseGround">
                    <!-- BaseGroundUnit are Just White BorderLines that lets the player know the coordinate-->
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                </div>
            </div>
            <div id="Board2" class = "GameDataBoard"></div>
        </div>

        
    </body>

</html>


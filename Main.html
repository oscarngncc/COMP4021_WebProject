<!DOCTYPE html>
<html>
    <head>
        <title>Special Tetris Game</title>
        <meta charset="utf-8"/>
        <link href="MainStyle.css" rel="stylesheet" type="text/css">
        <link href="Responsive.css" rel="stylesheet" type="text/css">
        <meta name="viewport" content="width=device-width, initial-scale=1" >
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    </head>

    <body onload="Main()">
        <!--Script Goes here-->
        <script src ="TetrisBlock.js"></script>
        <script>
            /* true if the block player previously controlled reaches to the bottom/another block*/
            var isSettled = true;

            /* Current Position of the User-Controlled TetrisBlock, based on Canvas*/
            var xPos = 0; 
            var yPos = 0;

            /* 10 x 8 2-Dimensional Matrix Canvas 
               with DOM "TetrisBlock" element inside if yes,
               null otherwise 
            */
            var Canvas = new Array(10);
            for ( var i = 0; i < 10; i++)
            {
                var Canvas_Col = new Array(8);
                Canvas[i] = Canvas_Col;
            }

            /*Timer*/
            var Timer;

            
            /* Helper Function for Changing position of elements inside Canvas, Parameters:
               Dimension - 0 which is x position, 1 which is y position
               Distance: How much (based on canvas) should the block move
            */
            function CanvasMoveBlock( Dimension, Distance )
            {
                //Blocks cannot be moved if it's already settled
                if ( isSettled  ){ return false; }

                //It may already be settled, but not updated yet
                if (  xPos == 9 || Canvas[xPos+1][yPos] != null )
                {
                    isSettled = true; return false;
                }

                //Out of Boundary Checking
                var Pos = ( Dimension == 0 )? xPos: yPos;
                var UpperBoundery = (Dimension == 0 )? 9 : 7;
                if ( Pos + Distance > UpperBoundery || Pos + Distance < 0 ){
                    return false; 
                }
                            
                var MovedxPos = ( Dimension == 0 )? xPos + Distance: xPos;
                var MovedyPos = ( Dimension != 0 )? yPos + Distance: yPos;
              
                //The Block needs to exist and the place it's going to move is not blocked by others
                if (Canvas[xPos][yPos] != null && Canvas[MovedxPos][MovedyPos] == null  )
                {
                    //Update Array
                    var block = Canvas[xPos][yPos];
                    Canvas[xPos].splice( yPos, 1, null );
                    Canvas[MovedxPos].splice( MovedyPos, 1, block );

                    //Update Actual Block Position in URL
                    block.style.top = (5 + MovedxPos*5).toString() + "rem"; 
                    block.style.left = (0 + MovedyPos*5 + 20 ).toString() + "rem";

                    xPos = MovedxPos;
                    yPos = MovedyPos;
                    
                    isSettled = false;
                    return true;
                }
                return false;   
            }


            function CreateBlock()
            {
                if ( isSettled )
                {
                    /* New Block Position, randomly of either 0-7th column and first row */
                    xPos = 0;
                    yPos = Math.floor( Math.random() * 8 );

                    //Make Previous UserControlBlocks no longer controllable                    
                    if ( $(".UserControlBlock")[0] )
                    {
                        //Previous block doesn't have ".UserControlBlock" class anymore
                        $(".UserControlBlock").each( function(){
                            $(this).attr("class", "TetrisBlock");
                        });
                    }

                    //Create new Block
                    var GameArea = document.getElementById("GameArea");
                    var block = document.createElement("div");
                    block.setAttribute("class", "TetrisBlock UserControlBlock");
                    block.style.top = (5 + xPos*5).toString() + "rem"; 
                    block.style.left = (0 + yPos*5 + 20 ).toString() + "rem";
                    GameArea.appendChild(block);
                    Canvas[0][yPos] = block;  //Add Block to Canvas

                    isSettled = false; 
                }              
            }


            function CheckRowCondition()
            {
                for ( var i = 9; i >= 0; i-- )
                {
                    var AllFilled = true;
                    for ( var j = 0; j < 8; j++ )
                    {
                        if ( Canvas[i][j] == null ){ AllFilled = false; break; }
                    }
                    //When a Row is filled, remove that row and update other TetrisBlock
                    if ( AllFilled ) 
                    {
                        //Revmove The Fully Filled Row
                        for ( var k = 0; k < 8; k++ )
                        {
                            var block = Canvas[i][k];
                            var GameArea = document.getElementById("GameArea");
                            GameArea.removeChild(block);
                            Canvas[i][k] = null;    
                        }
                        //Update All other tetrisBlocks by moving down 1 layer
                        for ( var a = i-1; a>= 0; a-- )
                        {
                            for ( var b = 0; b < 8; b++ )
                            {
                                //Update Array
                                var block = Canvas[a][b];
                                if ( block != null )
                                {
                                    Canvas[a].splice( b, 1, null );
                                    Canvas[a+1].splice( b, 1, block );
                                    block.style.top = (5 + (a+1)*5).toString() + "rem";   
                                }                              
                            }
                        }
                        i++; //Since the Next row we consider will actually moved down
                    }
                }
            }



            /*Function Called for each timer iteration, Bascially Sum up everything*/
            function IterationFunc()
            {
                CanvasMoveBlock( 0, 1 ); //User-Controlled Block will drop each time interval
                CheckRowCondition();

                //Check GameOver
                for ( var i = 0; i < 8; i++ )
                {
                    if ( Canvas[0][i] != null ){ 
                        isSettled = true;
                        clearTimeout(Timer);
                        alert("GAMEOVER"); 
                        return;
                    }
                }

                CreateBlock();
                Timer = setTimeout(IterationFunc, 500);
            }


            function Main()
            {
                Timer = setTimeout(IterationFunc, 500);

                //When User Press the button
                $(document).on("keydown", function(e){
                    if ( e.keyCode == 37 )  //Press Left
                    {
                        CanvasMoveBlock(1, -1);
                    }
                    else if ( e.keyCode == 39 ) //Press Right
                    {
                        CanvasMoveBlock(1, 1);
                    }
                    else if ( e.keyCode == 38 ) //Press Up, Change Direction
                    {

                    }
                    else if ( e.keyCode == 40 ) //Press Down, //Increase DownSpeed
                    {
                        CanvasMoveBlock(0, 1);
                    }
                });
            }

        </script>
        <!--Script Ends here-->

        <div id="Game">
            <div id = "Board1" class = "GameDataBoard">
                <p>Next Block Dropping:</p>
                <p>Score: 20000</p>
            </div>
            <div id = "GameArea">
                <div id="BorderLine"></div>
                <div id="BaseGround">
                    <!-- BaseGroundUnit are Just White BorderLines that lets the player know the coordinate-->
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                    <div class="BaseGroundUnit"></div>
                </div>
            </div>
            <div id="Board2" class = "GameDataBoard"></div>
        </div>

        
    </body>

</html>

